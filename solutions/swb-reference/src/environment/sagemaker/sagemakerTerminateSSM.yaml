description: SSM document to terminate a Sagemaker instance
schemaVersion: '0.3'
parameters:
  ProvisionedProductId:
    type: String
    description: 'The ID of the Sagemaker provisioned product being terminated.'
  TerminateToken:
    type: String
    description: '(Required) The unique token ID assigned to this request.'
  EventBusName:
    type: String
    description: 'The main account event bridge bus name.'
  EnvId:
    type: String
    description: 'The ID of the environment resource stored in DDB'
  EventBridgeStatusUpdateEventType:
    type: String
    description: 'The string value used by main account to filter host events'
mainSteps:
  - name: TerminateSagemaker
    action: 'aws:executeAwsApi'
    inputs:
      Service: servicecatalog
      Api: TerminateProvisionedProduct
      ProvisionedProductId: '{{ ProvisionedProductId }}'
      TerminateToken: '{{ TerminateToken }}'
    outputs:
      - Name: RecordId
        Type: String
        Selector: '$.RecordDetail.RecordId'
    nextStep: WaitForTerminating
  - name: WaitForTerminating
    action: 'aws:waitForAwsResourceProperty'
    timeoutSeconds: 600
    inputs:
      Service: servicecatalog
      Api: DescribeRecord
      Id: '{{ TerminateSagemaker.RecordId }}'
      DesiredValues:
        - SUCCEEDED
      PropertySelector: '$.RecordDetail.Status'
    outputs:
      - Name: ProvisionedProductDetail
        Type: StringMap
        Selector: '$.ProvisionedProductDetail'
    onFailure: step:PushFailureStatusToEventBridge
    nextStep: PushMetadataToEventBridge
  - name: PushMetadataToEventBridge
    action: 'aws:executeAwsApi'
    inputs:
      Service: events
      Api: PutEvents
      Entries:
        - Detail: '{ "EnvId": "{{ EnvId }}", "ProvisionedProductId": "{{ ProvisionedProductId }}", "RecordId": "{{ TerminateSagemaker.RecordId }}", "EnvType": "Sagemaker", "Operation": "Terminate", "Status": "TERMINATED" }'
          DetailType: '{{ EventBridgeStatusUpdateEventType }}'
          EventBusName: '{{ EventBusName }}'
          Source: 'aws.automation' # This is being used for updating env in statusHandler lambda
    isEnd: true
  - name: PushFailureStatusToEventBridge
    action: 'aws:executeAwsApi'
    inputs:
      Service: events
      Api: PutEvents
      Entries:
        - Detail: '{ "EnvId": "{{ EnvId }}", "ProvisionedProductId": "{{ ProvisionedProductId }}", "RecordId": "{{ TerminateSagemaker.RecordId }}", "EnvType": "Sagemaker", "Operation": "Terminate", "Status": "TERMINATING_FAILED" }'
          DetailType: '{{ EventBridgeStatusUpdateEventType }}'
          EventBusName: '{{ EventBusName }}'
          Source: 'aws.automation' # This is being used for updating env in statusHandler lambda
    isEnd: true
