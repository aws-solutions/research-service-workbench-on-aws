description: SSM document to start a Sagemaker instance
schemaVersion: '0.3'
parameters:
  NotebookInstanceName:
    type: String
    description: 'The Sagemaker notebook instance name being started.'
    default: ''
  EventBusName:
    type: String
    description: 'The main account event bridge bus name.'
    default: ''
  EnvId:
    type: String
    description: 'The ID of the environment resource stored in DDB'
    default: ''
  EnvStatusUpdateConstString:
    type: String
    description: 'The string value used by main account to filter host events'
    default: ''
mainSteps:
  - name: StartSagemaker
    action: 'aws:executeAwsApi'
    inputs:
      Service: sagemaker
      Api: StartNotebookInstance
      NotebookInstanceName: '{{ NotebookInstanceName }}'
    nextStep: WaitForStarting
  - name: WaitForStarting
    action: 'aws:waitForAwsResourceProperty'
    timeoutSeconds: 600
    inputs:
      Service: sagemaker
      Api: DescribeNotebookInstance
      NotebookInstanceName: '{{ NotebookInstanceName }}'
      DesiredValues:
        - InService
      PropertySelector: '$.NotebookInstanceStatus'
    onFailure: step:PushFailureStatusToEventBridge
    nextStep: PushMetadataToEventBridge
  - name: PushMetadataToEventBridge
    action: 'aws:executeAwsApi'
    inputs:
      Service: events
      Api: PutEvents
      Entries:
        - Detail: '{ "EnvId": "{{ EnvId }}", "NotebookInstanceName": "{{ NotebookInstanceName }}", "EnvType": "Sagemaker", "Operation": "Start", "Status": "STARTED" }'
          DetailType: '{{ EnvStatusUpdateConstString }}'
          EventBusName: '{{ EventBusName }}'
          Source: 'StartSagemaker'
    isEnd: true
  - name: PushFailureStatusToEventBridge
    action: 'aws:executeAwsApi'
    inputs:
      Service: events
      Api: PutEvents
      Entries:
        - Detail: '{ "EnvId": "{{ EnvId }}", "NotebookInstanceName": "{{ NotebookInstanceName }}", "EnvType": "Sagemaker", "Operation": "Start", "Status": "STARTING_FAILED" }'
          DetailType: '{{ EnvStatusUpdateConstString }}'
          EventBusName: '{{ EventBusName }}'
          Source: 'StartSagemaker'
    isEnd: true
