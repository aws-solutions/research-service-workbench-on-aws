#
#  Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.
#  SPDX-License-Identifier: Apache-2.0
#
name: Build-and-test
on: ['pull_request']

jobs:
  # verify-commit-msg:
  #   runs-on: ubuntu-20.04
  #   outputs:
  #       not-match: ${{ steps.verify-commit-msg.outputs.not-match }}
          
  #   steps:
  #     - name: Checkout repository
  #       uses: actions/checkout@v3
  #       with: 
  #         ref: ${{ github.head_ref }}
  #         token: ${{ secrets.MERGE_TOKEN }}

  #     - name: Get last commit message
  #       id: last-commit-message
  #       run: |
  #         echo "::set-output name=msg::$(git log -1 --pretty=format:'%s %al <%ce> %GK')"

  #     - name: Verify the auto commit message
  #       id: verify-commit-msg
  #       run: |
  #         if [[ "${{ secrets.AUTO_COMMIT_MATCHER }}" != "${{ steps.last-commit-message.outputs.msg }}" ]];
  #         then
  #           echo "::set-output name=not-match::true"
  #         else
  #           echo "::set-output name=not-match::false"
  #         fi

  build-and-test:
    runs-on: ubuntu-20.04
    # needs: [verify-commit-msg]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with: 
          ref: ${{ github.head_ref }}
          token: ${{ secrets.MERGE_TOKEN }}

      - name: Base Action
        # if: needs.verify-commit-msg.outputs.not-match == 'true'
        uses: ./.github/actions/baseAction
      
      - name: Rush test and update the README file in each package with the coverage badge
        # if: needs.verify-commit-msg.outputs.not-match == 'true'
        run: node common/scripts/install-run-rush.js test --verbose

      # - name: Cfn-nag Action
      #   # if: needs.verify-commit-msg.outputs.not-match == 'true'
      #   uses: ./.github/actions/cfnNagAction

      # - name: Git-secrets Action
      #   # if: needs.verify-commit-msg.outputs.not-match == 'true'
      #   uses: ./.github/actions/gitSecretsAction

      # - name: Viperlight Action
      #   # if: needs.verify-commit-msg.outputs.not-match == 'true'
      #   uses: ./.github/actions/viperlightAction

          

